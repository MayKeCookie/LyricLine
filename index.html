<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>简谱编辑助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 自定义字体导入 -->
  <link href="https://fontsapi.zeoseven.com/40/main/result.css" rel="stylesheet">
  <link href="https://fontsapi.zeoseven.com/446/main/result.css" rel="stylesheet">
  <link href="https://fontsapi.zeoseven.com/708/main/result.css" rel="stylesheet">
  <link href="https://fontsapi.zeoseven.com/570/main/result.css" rel="stylesheet">
  <link href="https://fontsapi.zeoseven.com/501/main/result.css" rel="stylesheet">
  <link href="https://fontsapi.zeoseven.com/442/main/result.css" rel="stylesheet">
  
  <!-- 自定义图标样式 -->
  <style>
    .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5em;
      height: 1.5em;
    }
    
    /* 确保字体支持加粗 */
    body, h1, h2, h3, h4, h5, h6, .font-bold, strong {
      font-weight: bold !important;
    }
    
    /* 为每个字体指定加粗支持 */
    .font-bold-maple-mono {
      font-family: 'Maple Mono NF CN', monospace;
      font-weight: bold;
    }
    .font-bold-otsutome {
      font-family: 'Otsutome_font', sans-serif;
      font-weight: bold;
    }
    .font-bold-yffyt {
      font-family: 'YFFYT', sans-serif;
      font-weight: bold;
    }
    .font-bold-swei {
      font-family: 'Swei Sans CJK SC Regular', sans-serif;
      font-weight: bold;
    }
    .font-bold-pixel {
      font-family: 'Fusion Pixel 12px M latin', monospace;
      font-weight: bold;
    }
    .font-bold-square {
      font-family: '平方手书体', sans-serif;
      font-weight: bold;
    }
  </style>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#8B5CF6',
            neutral: '#1F2937',
            light: '#F3F4F6'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .note-input-focus {
        @apply ring-2 ring-primary/50 ring-offset-2;
      }
      .section-transition {
        @apply transition-all duration-300 ease-in-out;
      }
      .btn-hover {
        @apply hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200;
      }
      .note-container {
        position: relative;
        display: inline-block;
        text-align: center;
        min-width: 20px;
      }
      .note-superscript {
        position: relative;
        text-align: center;
        font-size: 0.6em;
        line-height: 1;
      }
      .note-subscript {
        position: relative;
        text-align: center;
        font-size: 0.6em;
        line-height: 1;
      }
      .note-number {
        display: inline-block;
        line-height: 1;
      }
      .keyboard-btn {
        @apply w-10 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition-colors;
      }
      .keyboard-btn-active {
        @apply bg-primary text-white border-primary;
      }
      .keyboard-octave {
        @apply w-16 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition-colors;
      }
      .keyboard-control {
        @apply w-16 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition-colors;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-neutral min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-music text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-neutral">简谱编辑助手</h1>
      </div>
      <div class="flex items-center space-x-3">
        <button id="helpBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-question-circle text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 帮助提示框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-neutral">使用帮助</h2>
          <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="space-y-4 text-gray-700">
          <div>
            <h3 class="font-semibold text-primary mb-2">1. 歌词编辑</h3>
            <p>在左侧文本框中输入或粘贴歌词，每行代表一句，系统会自动分割为单个歌词单元。</p>
          </div>
          <div>
            <h3 class="font-semibold text-primary mb-2">2. 简谱设置</h3>
            <ul class="list-disc pl-5 space-y-1">
              <li>点击简谱输入框使其获得焦点</li>
              <li>按数字键1-7输入基本音符，输入后自动切换到下一个字</li>
              <li>按+键升高当前音符音调（数字正上方加点）</li>
              <li>按-键降低当前音符音调（数字正下方加点）</li>
              <li>按Delete或Backspace删除音符</li>
              <li>使用屏幕键盘也可以输入音符</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-primary mb-2">3. 全局音调设置</h3>
            <p>使用全局音调控制可以为下一个输入的音符设置固定的升降调：</p>
            <ul class="list-disc pl-5 space-y-1">
              <li>点击"+"按钮增加全局升调值</li>
              <li>点击"-"按钮增加全局降调值</li>
              <li>点击"重置"按钮清除全局音调设置</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-primary mb-2">4. 导出图片</h3>
            <p>编辑完成后，点击"导出为图片"按钮，即可将简谱保存为图片文件。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 主内容区域布局 - 重新设计 -->
    <div class="space-y-6">
      <!-- 第一部分：歌词输入与歌曲信息区域（顶部） -->
      <div class="bg-white rounded-xl shadow p-5 section-transition hover:shadow-md">
        <h2 class="text-lg font-semibold text-neutral flex items-center mb-4">
          <i class="fa fa-file-text text-primary mr-2"></i>歌词输入与歌曲信息
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 左侧：歌词输入 -->
          <div>
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center space-x-2 bg-light px-2 py-1 rounded-md">
                <button id="decreaseToneBtn" class="p-1.5 rounded hover:bg-gray-200 text-gray-700">
                  <i class="fa fa-minus"></i>
                </button>
                <span id="globalToneDisplay" class="text-sm font-medium w-10 text-center">±0</span>
                <button id="increaseToneBtn" class="p-1.5 rounded hover:bg-gray-200 text-gray-700">
                  <i class="fa fa-plus"></i>
                </button>
                <button id="resetToneBtn" class="text-xs text-gray-500 hover:text-gray-700 px-1">重置</button>
              </div>
              <button id="splitLyricsBtn" class="bg-primary text-white px-3 py-1 rounded-md text-sm btn-hover">
                <i class="fa fa-magic mr-1"></i>分割歌词
              </button>
            </div>
            
            <div class="mb-3">
              <textarea id="lyricsInput" placeholder="请输入或粘贴歌词，每行一句..." 
                class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
            </div>
            <div class="flex space-x-2">
              <button id="clearLyricsBtn" class="flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm btn-hover">
                <i class="fa fa-trash mr-1"></i>清空
              </button>
              <button id="sampleLyricsBtn" class="flex-1 bg-accent text-white px-3 py-2 rounded-md text-sm btn-hover">
                <i class="fa fa-file-text-o mr-1"></i>示例歌词
              </button>
            </div>
          </div>
          
          <!-- 右侧：歌曲信息 -->
          <div>
            <!-- 歌曲信息卡片 -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-100">
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-music text-primary/80 mr-2"></i>基本信息
              </h3>
              <div class="space-y-3">
                <div class="space-y-1">
                  <label for="songTitleInput" class="block text-xs text-gray-500 font-medium">歌名</label>
                  <input type="text" id="songTitleInput" placeholder="请输入歌名" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                </div>
                <div class="space-y-1">
                  <label for="singerInput" class="block text-xs text-gray-500 font-medium">歌手</label>
                  <input type="text" id="singerInput" placeholder="请输入歌手名" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div class="space-y-1">
                    <label for="composerInput" class="block text-xs text-gray-500 font-medium">作曲</label>
                    <input type="text" id="composerInput" placeholder="请输入作曲者" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  </div>
                  <div class="space-y-1">
                    <label for="lyricistInput" class="block text-xs text-gray-500 font-medium">作词</label>
                    <input type="text" id="lyricistInput" placeholder="请输入作词者" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 第二部分：预览区域与简谱编辑区域（中间） -->
      <div class="bg-white rounded-xl shadow p-5 section-transition hover:shadow-md">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 左侧：预览区域 -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-neutral flex items-center">
                <i class="fa fa-eye text-primary mr-2"></i>预览区域
              </h2>
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">宽高比:</span>
                <select id="aspectRatioSelect" class="p-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                  <option value="16:9">16:9</option>
                  <option value="4:3" selected>4:3</option>
                  <option value="3:2">3:2</option>
                  <option value="1:1">1:1</option>
                  <option value="custom">自定义</option>
                </select>
              </div>
            </div>
            
            <!-- 自定义宽高比输入框 -->
            <div id="customRatioInputs" class="hidden mb-3 flex items-center space-x-2">
              <input type="number" id="widthInput" placeholder="宽度" min="100" value="800" class="w-24 p-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <span class="text-gray-600">:</span>
              <input type="number" id="heightInput" placeholder="高度" min="100" value="600" class="w-24 p-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
              <button id="applyRatioBtn" class="bg-primary text-white px-2 py-1 rounded-md text-xs btn-hover">
                <i class="fa fa-check mr-1"></i>应用
              </button>
            </div>
            
            <div id="previewContainer" class="relative">
              <div id="previewArea" class="border border-gray-200 rounded-lg p-4 bg-light aspect-[4/3]">
                <div class="text-gray-500 text-center py-10">
                  <p>编辑后的简谱将在这里显示</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 右侧：简谱编辑区域 -->
          <div>
            <h2 class="text-lg font-semibold text-neutral flex items-center mb-4">
              <i class="fa fa-edit text-primary mr-2"></i>简谱编辑区域
            </h2>
            <div id="notesEditor" class="space-y-3 max-h-[60vh] overflow-y-auto p-2">
              <div class="text-gray-500 text-center py-10 border-2 border-dashed border-gray-200 rounded-lg">
                <p>请先输入歌词并点击"分割歌词"按钮</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 第三部分：导出与预览设置（底部） -->
      <div class="bg-white rounded-xl shadow p-5 section-transition hover:shadow-md">
        <!-- 标签页标题 -->
        <div class="flex border-b border-gray-200 bg-gradient-to-r from-primary/5 to-white mb-4">
          <button id="exportTabBtn" class="px-5 py-2.5 text-sm font-medium text-primary border-b-2 border-primary focus:outline-none flex items-center">
            <i class="fa fa-download mr-2"></i>导出设置
          </button>
          <button id="previewTabBtn" class="px-5 py-2.5 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none flex items-center">
            <i class="fa fa-sliders mr-2"></i>预览设置
          </button>
        </div>
        
        <!-- 导出设置标签页内容 -->
        <div id="exportTabContent">
          <div class="flex justify-end mb-4">
            <div class="space-x-2">
              <button id="exportImageBtn" class="bg-secondary text-white px-3 py-1.5 rounded-md text-sm font-medium btn-hover transition-all hover:shadow-md">
                <i class="fa fa-image mr-1"></i>导出当前页
              </button>
              <button id="exportAllBtn" class="bg-accent text-white px-3 py-1.5 rounded-md text-sm font-medium btn-hover transition-all hover:shadow-md">
                <i class="fa fa-files-o mr-1"></i>导出全部
              </button>
            </div>
          </div>
          
          <!-- 导出选项卡片 -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
            <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
              <i class="fa fa-cog text-primary/80 mr-2"></i>导出选项
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="space-y-1">
                <label for="exportFormatSelect" class="block text-xs text-gray-500 font-medium">导出格式</label>
                <select id="exportFormatSelect" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  <option value="png" selected>PNG</option>
                  <option value="jpg">JPG</option>
                  <option value="pdf">PDF (Beta)</option>
                </select>
              </div>
              
              <div class="space-y-1">
                <label for="resolutionSelect" class="block text-xs text-gray-500 font-medium">导出分辨率</label>
                <select id="resolutionSelect" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  <option value="1">标准 (1x)</option>
                  <option value="2" selected>高清 (2x)</option>
                  <option value="3">超清 (3x)</option>
                </select>
              </div>
              
              <div class="space-y-1">
                <label for="linesPerPageInput" class="block text-xs text-gray-500 font-medium">每页行数</label>
                <div class="flex items-center space-x-2">
                  <input type="number" id="linesPerPageInput" min="1" value="4" class="w-24 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  <span class="text-gray-600">行/页</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 底部操作按钮 -->
          <div class="flex justify-between items-center border-t border-gray-100 pt-4 mt-4">
            <div class="flex space-x-2">
              <button id="exportDataBtn" class="bg-primary text-white px-3 py-1.5 rounded-md text-sm btn-hover">
                <i class="fa fa-download mr-1"></i>导出数据
              </button>
              <label id="importDataBtn" class="cursor-pointer bg-gray-700 text-white px-3 py-1.5 rounded-md text-sm btn-hover inline-block">
                <i class="fa fa-upload mr-1"></i>导入数据
                <input type="file" id="dataFileInput" accept=".json" class="hidden">
              </label>
            </div>
            <button id="applySettingsBtn" class="bg-primary text-white px-5 py-1.5 rounded-md font-medium btn-hover transition-all hover:shadow-md hover:bg-primary/90">
              <i class="fa fa-check mr-1.5"></i>应用设置
            </button>
          </div>
        </div>
        
        <!-- 预览设置标签页内容 - 初始隐藏 -->
        <div id="previewTabContent" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 左侧：字体和颜色设置 -->
            <div>
              <!-- 字体设置卡片 -->
              <div class="bg-gray-50 rounded-lg p-4 mb-5 border border-gray-100">
                <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                  <i class="fa fa-font text-primary/80 mr-2"></i>字体设置
                </h3>
                <div class="space-y-4">
                  <!-- 字体选择 -->
                  <div class="space-y-1">
                    <label for="fontSelect" class="block text-xs text-gray-500 font-medium">字体选择</label>
                    <select id="fontSelect" class="w-full min-w-[200px] p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                      <option value="'Maple Mono NF CN', monospace" selected>Maple Mono NF CN (默认)</option>
                      <option value="'Otsutome_font', sans-serif">Otsutome_font</option>
                      <option value="'YFFYT', sans-serif">YFFYT</option>
                      <option value="'Swei Sans CJK SC Regular', sans-serif">Swei Sans CJK SC</option>
                      <option value="'Fusion Pixel 12px M latin', monospace">Fusion Pixel 12px M latin</option>
                      <option value="'平方手书体', sans-serif">平方手书体</option>
                    </select>
                  </div>
                  
                  <!-- 字体大小和加粗设置 -->
                  <div class="space-y-1">
                    <label class="block text-xs text-gray-500 font-medium">字体大小 <span id="fontSizeDisplay" class="text-primary font-medium">16</span>px</label>
                    <div class="flex items-center gap-2">
                      <input type="range" id="fontSizeSlider" min="12" max="28" value="16" step="1"
                        class="flex-1 h-2.5 bg-gray-200 rounded-lg appearance-none cursor-pointer transition-all focus:outline-none focus:ring-2 focus:ring-primary/50">
                      <button id="toggleBoldBtn" class="h-8 w-8 flex items-center justify-center border border-gray-200 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 hover:bg-gray-50 transition-all" title="字体加粗">
                        <i class="fa fa-bold text-gray-600"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 颜色设置卡片 -->
              <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                  <i class="fa fa-paint-brush text-primary/80 mr-2"></i>颜色设置
                </h3>
                <div class="space-y-4">
                  <!-- 音符颜色 -->
                  <div class="space-y-1">
                    <label for="noteColorPicker" class="block text-xs text-gray-500 font-medium">音符颜色</label>
                    <div class="flex items-center space-x-2">
                      <input type="color" id="noteColorPicker" value="#3B82F6" class="w-10 h-10 border-0 rounded-full cursor-pointer transition-transform hover:scale-105 shadow-sm">
                      <select id="noteColorSelect" class="flex-1 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                        <option value="#3B82F6">蓝色</option>
                        <option value="#10B981">绿色</option>
                        <option value="#EF4444">红色</option>
                        <option value="#8B5CF6">紫色</option>
                        <option value="#F59E0B">橙色</option>
                        <option value="#1F2937">黑色</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- 歌词颜色 -->
                  <div class="space-y-1">
                    <label for="textColorPicker" class="block text-xs text-gray-500 font-medium">歌词颜色</label>
                    <div class="flex items-center space-x-2">
                      <input type="color" id="textColorPicker" value="#1F2937" class="w-10 h-10 border-0 rounded-full cursor-pointer transition-transform hover:scale-105 shadow-sm">
                      <select id="textColorSelect" class="flex-1 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                        <option value="#1F2937">黑色</option>
                        <option value="#3B82F6">蓝色</option>
                        <option value="#10B981">绿色</option>
                        <option value="#EF4444">红色</option>
                        <option value="#8B5CF6">紫色</option>
                        <option value="#F59E0B">橙色</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 右侧：背景设置 -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-images text-primary/80 mr-2"></i>背景设置
              </h3>
              
              <!-- 预设背景选择 -->
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="none">
                  <div class="w-full aspect-[4/3] bg-white rounded border border-gray-200 flex items-center justify-center shadow-sm">
                    <span class="text-xs text-gray-500">无背景</span>
                  </div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片1.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片1.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片2.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片2.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片3.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片3.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片4.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片4.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片5.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片5.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片6.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片6.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片7.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片7.png');"></div>
                </div>
                <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片8.png">
                  <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片8.png');"></div>
                </div>
              </div>
              
              <!-- 自定义背景上传 -->
              <div class="bg-gray-50 rounded-lg border border-gray-200 p-3">
                <div class="flex flex-col gap-2">
                  <div class="relative">
                    <input type="file" id="bgImageUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 text-center bg-white hover:bg-gray-50 transition-colors">
                      <i class="fa fa-picture-o text-gray-400 text-lg mb-1"></i>
                      <p class="text-xs text-gray-600">点击上传背景图片</p>
                    </div>
                  </div>
                  <button id="clearBgBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 flex items-center justify-center shadow-sm">
                    <i class="fa fa-times mr-1.5"></i>清除背景
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        
        <script>
          // 标签页切换功能
          document.addEventListener('DOMContentLoaded', function() {
            const exportTabBtn = document.getElementById('exportTabBtn');
            const previewTabBtn = document.getElementById('previewTabBtn');
            
            const exportTabContent = document.getElementById('exportTabContent');
            const previewTabContent = document.getElementById('previewTabContent');
            
            // 重置所有标签页样式和内容显示
            function resetTabs() {
              // 重置所有按钮样式
              [exportTabBtn, previewTabBtn].forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btn.classList.add('text-gray-600');
              });
              
              // 隐藏所有内容区域
              [exportTabContent, previewTabContent].forEach(content => {
                content.classList.add('hidden');
              });
            }
            
            // 切换到导出设置标签
            exportTabBtn.addEventListener('click', function() {
              resetTabs();
              exportTabBtn.classList.add('text-primary', 'border-b-2', 'border-primary');
              exportTabBtn.classList.remove('text-gray-600');
              exportTabContent.classList.remove('hidden');
            });
            
            // 切换到预览设置标签
            previewTabBtn.addEventListener('click', function() {
              resetTabs();
              previewTabBtn.classList.add('text-primary', 'border-b-2', 'border-primary');
              previewTabBtn.classList.remove('text-gray-600');
              previewTabContent.classList.remove('hidden');
            });
          });
        </script>
        
        <!-- 导出设置标签页内容 -->
        <div id="exportTabContent">
          <div class="p-5">
            <div class="flex justify-end mb-4">
              <div class="space-x-2">
                <button id="exportImageBtn" class="bg-secondary text-white px-3 py-1.5 rounded-md text-sm font-medium btn-hover transition-all hover:shadow-md">
                  <i class="fa fa-image mr-1"></i>导出当前页
                </button>
                <button id="exportAllBtn" class="bg-accent text-white px-3 py-1.5 rounded-md text-sm font-medium btn-hover transition-all hover:shadow-md">
                  <i class="fa fa-files-o mr-1"></i>导出全部
                </button>
              </div>
            </div>
            
            <!-- 歌曲信息卡片 -->
            <div class="bg-gray-50 rounded-lg p-4 mb-5 border border-gray-100">
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-music text-primary/80 mr-2"></i>歌曲信息
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                  <label for="songTitleInput" class="block text-xs text-gray-500 font-medium">歌名</label>
                  <input type="text" id="songTitleInput" placeholder="请输入歌名" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                </div>
                <div class="space-y-1">
                  <label for="singerInput" class="block text-xs text-gray-500 font-medium">歌手</label>
                  <input type="text" id="singerInput" placeholder="请输入歌手名" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                </div>
              </div>
            </div>
            
            <!-- 导出选项卡片 -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-cog text-primary/80 mr-2"></i>导出选项
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 导出格式 -->
                <div class="space-y-1">
                  <label for="exportFormatSelect" class="block text-xs text-gray-500 font-medium">导出格式</label>
                  <select id="exportFormatSelect" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                    <option value="png" selected>PNG</option>
                    <option value="jpg">JPG</option>
                    <option value="pdf">PDF (Beta)</option>
                  </select>
                </div>
                
                <!-- 导出分辨率 -->
                <div class="space-y-1">
                  <label for="resolutionSelect" class="block text-xs text-gray-500 font-medium">导出分辨率</label>
                  <select id="resolutionSelect" class="w-full p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                    <option value="1">标准 (1x)</option>
                    <option value="2" selected>高清 (2x)</option>
                    <option value="3">超清 (3x)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 分页设置 -->
          <div class="border-t border-gray-100 p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label for="linesPerPageInput" class="block text-xs text-gray-500 font-medium">每页行数</label>
                <div class="flex items-center space-x-2">
                  <input type="number" id="linesPerPageInput" min="1" value="4" class="w-24 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white">
                  <span class="text-gray-600">行/页</span>
                </div>
              </div>
              
              <!-- 当前页码 -->
              <div id="pageInfo" class="hidden">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600">当前显示: <span id="currentPageDisplay">1</span>/<span id="totalPagesDisplay">1</span></span>
                  <div class="flex space-x-1">
                    <button id="prevPageBtn" class="p-1 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fa fa-chevron-left"></i>
                    </button>
                    <button id="nextPageBtn" class="p-1 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fa fa-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 导出状态 -->
          <div id="exportStatus" class="hidden px-5 pb-5">
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
              <span class="block sm:inline">图片导出成功！已导出 <span id="exportedCount">0</span> 张图片</span>
              <button class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.classList.add('hidden')">
                <i class="fa fa-times text-green-500"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 预览设置标签页内容 - 初始隐藏 -->
        <div id="previewTabContent" class="hidden">
          <div class="p-5">
            <!-- 字体设置卡片 -->
            <div class="bg-gray-50 rounded-lg p-4 mb-5 border border-gray-100">
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-font text-primary/80 mr-2"></i>字体设置
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 字体选择 -->
                <div class="space-y-1">
                  <label for="fontSelect" class="block text-xs text-gray-500 font-medium">字体选择</label>
                  <select id="fontSelect" class="w-full min-w-[200px] p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                    <option value="'Maple Mono NF CN', monospace" selected>Maple Mono NF CN (默认)</option>
                    <option value="'Otsutome_font', sans-serif">Otsutome_font</option>
                    <option value="'YFFYT', sans-serif">YFFYT</option>
                    <option value="'Swei Sans CJK SC Regular', sans-serif">Swei Sans CJK SC</option>
                    <option value="'Fusion Pixel 12px M latin', monospace">Fusion Pixel 12px M latin</option>
                    <option value="'平方手书体', sans-serif">平方手书体</option>
                  </select>
                </div>
                
                <!-- 字体大小和加粗设置 -->
                <div class="space-y-1">
                  <label class="block text-xs text-gray-500 font-medium">字体大小 <span id="fontSizeDisplay" class="text-primary font-medium">16</span>px</label>
                  <div class="flex items-center gap-2">
                    <input type="range" id="fontSizeSlider" min="12" max="28" value="16" step="1"
                      class="flex-1 h-2.5 bg-gray-200 rounded-lg appearance-none cursor-pointer transition-all focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <button id="toggleBoldBtn" class="h-8 w-8 flex items-center justify-center border border-gray-200 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 hover:bg-gray-50 transition-all" title="字体加粗">
                      <i class="fa fa-bold text-gray-600"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 颜色设置卡片 -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
              <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                <i class="fa fa-paint-brush text-primary/80 mr-2"></i>颜色设置
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 音符颜色 -->
                <div class="space-y-1">
                  <label for="noteColorPicker" class="block text-xs text-gray-500 font-medium">音符颜色</label>
                  <div class="flex items-center space-x-2">
                    <input type="color" id="noteColorPicker" value="#3B82F6" class="w-10 h-10 border-0 rounded-full cursor-pointer transition-transform hover:scale-105 shadow-sm">
                    <select id="noteColorSelect" class="flex-1 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                      <option value="#3B82F6">蓝色</option>
                      <option value="#10B981">绿色</option>
                      <option value="#EF4444">红色</option>
                      <option value="#8B5CF6">紫色</option>
                      <option value="#F59E0B">橙色</option>
                      <option value="#1F2937">黑色</option>
                    </select>
                  </div>
                </div>
                
                <!-- 歌词颜色 -->
                <div class="space-y-1">
                  <label for="textColorPicker" class="block text-xs text-gray-500 font-medium">歌词颜色</label>
                  <div class="flex items-center space-x-2">
                    <input type="color" id="textColorPicker" value="#1F2937" class="w-10 h-10 border-0 rounded-full cursor-pointer transition-transform hover:scale-105 shadow-sm">
                    <select id="textColorSelect" class="flex-1 p-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all bg-white hover:border-gray-300">
                      <option value="#1F2937">黑色</option>
                      <option value="#3B82F6">蓝色</option>
                      <option value="#10B981">绿色</option>
                      <option value="#EF4444">红色</option>
                      <option value="#8B5CF6">紫色</option>
                      <option value="#F59E0B">橙色</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 背景设置 -->
          <div class="border-t border-gray-100">
            <div class="p-5">
              <!-- 预设背景选择 -->
              <div class="mb-5">
                <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                  <i class="fa fa-images text-primary/80 mr-2"></i>预设背景
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="none">
                    <div class="w-full aspect-[4/3] bg-white rounded border border-gray-200 flex items-center justify-center shadow-sm">
                      <span class="text-xs text-gray-500">无背景</span>
                    </div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片1.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片1.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片2.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片2.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片3.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片3.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片4.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片4.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片5.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片5.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片6.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片6.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片7.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片7.png');"></div>
                  </div>
                  <div class="border-2 border-transparent rounded-lg p-1 cursor-pointer hover:border-primary hover:shadow-md transition-all transform hover:scale-[1.02] bg-white" data-bg="简谱背景图片8.png">
                    <div class="w-full aspect-[4/3] bg-cover bg-center rounded border border-gray-100 shadow-sm" style="background-image: url('简谱背景图片8.png');"></div>
                  </div>
                </div>
              </div>
              
              <!-- 自定义背景上传 -->
              <div>
                <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                  <i class="fa fa-cloud-upload text-primary/80 mr-2"></i>自定义背景
                </h3>
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                  <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1 relative">
                      <input type="file" id="bgImageUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                      <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-white hover:bg-gray-50 transition-colors">
                        <i class="fa fa-picture-o text-gray-400 text-xl mb-2"></i>
                        <p class="text-sm text-gray-600">点击或拖拽上传背景图片</p>
                        <p class="text-xs text-gray-500 mt-1">支持 JPG、PNG、GIF 等常见格式</p>
                      </div>
                    </div>
                    <button id="clearBgBtn" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 flex items-center justify-center shadow-sm">
                      <i class="fa fa-times mr-2"></i>清除背景
                    </button>
              </select>
            </div>
            

          </div>
        </div>
        
        <!-- 颜色设置卡片 -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
          <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
            <i class="fa fa-paint-brush text-primary/80 mr-2"></i>颜色设置
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 音符颜色 -->
          </div>
        </div>
      </div>
      
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t mt-8 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>简谱编辑助手 &copy; 2025 - 轻松创作你的音乐简谱</p>
    </div>
  </footer>

  <script>
    // 全局变量
    let lyricsData = []; // 存储歌词和对应的简谱数据，按行组织
    let globalToneOffset = 0; // 全局音调偏移值，0为默认，正数为升调，负数为降调
    let currentOctave = 0; // 当前八度，0为中央C，正数为高八度，负数为低八度
    let currentFocusRow = -1; // 当前聚焦的行索引
    let currentFocusIndex = -1; // 当前聚焦的音符在该行中的索引
    
    // 预览设置
    let previewSettings = {
      font: '\'Maple Mono NF CN\', monospace',
      fontSize: 16,
      noteColor: '#3B82F6',
      textColor: '#1F2937',
      backgroundColor: 'none',
      backgroundImage: 'none',
      aspectRatio: '4:3',
      width: 800,
      height: 600,
      bold: false
    };
    
    // 分页设置
    let paginationSettings = {
      currentPage: 1,
      linesPerPage: 4,
      totalPages: 1
    };

    // DOM 元素
    const lyricsInput = document.getElementById('lyricsInput');
    const splitLyricsBtn = document.getElementById('splitLyricsBtn');
    const clearLyricsBtn = document.getElementById('clearLyricsBtn');
    const sampleLyricsBtn = document.getElementById('sampleLyricsBtn');
    const notesEditor = document.getElementById('notesEditor');
    const previewArea = document.getElementById('previewArea');
    const exportImageBtn = document.getElementById('exportImageBtn');
    const exportStatus = document.getElementById('exportStatus');
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('helpModal');
    const closeHelpBtn = document.getElementById('closeHelpBtn');
    const increaseToneBtn = document.getElementById('increaseToneBtn');
    const decreaseToneBtn = document.getElementById('decreaseToneBtn');
    const resetToneBtn = document.getElementById('resetToneBtn');
    const globalToneDisplay = document.getElementById('globalToneDisplay');

    // 初始化事件监听
    function initEventListeners() {
      // 歌词处理按钮
      splitLyricsBtn.addEventListener('click', splitLyrics);
      clearLyricsBtn.addEventListener('click', clearLyrics);
      sampleLyricsBtn.addEventListener('click', loadSampleLyrics);
      
      // 导出图片
      exportImageBtn.addEventListener('click', () => exportAsImage());
      
      // 帮助模态框
      helpBtn.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
        helpModal.classList.add('flex');
      });
      
      closeHelpBtn.addEventListener('click', () => {
        helpModal.classList.add('hidden');
        helpModal.classList.remove('flex');
      });
      
      // 点击模态框外部关闭
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
          helpModal.classList.add('hidden');
          helpModal.classList.remove('flex');
        }
      });
      
      // 全局音调控制（限制在-1至2之间）
      increaseToneBtn.addEventListener('click', () => {
        if (globalToneOffset < 2) {
          globalToneOffset++;
          updateToneDisplay();
        }
      });
      
      decreaseToneBtn.addEventListener('click', () => {
        if (globalToneOffset > -1) {
          globalToneOffset--;
          updateToneDisplay();
        }
      });
      
      resetToneBtn.addEventListener('click', () => {
        globalToneOffset = 0;
        updateToneDisplay();
      });
      
      // 键盘事件监听 - 响应+和-键控制全局音调
      document.addEventListener('keydown', (e) => {
        const activeElement = document.activeElement;
        const isNoteInput = activeElement.classList.contains('note-input');
        const isTextInput = ['INPUT', 'TEXTAREA'].includes(activeElement.tagName);
        
        // 如果是音符输入框，允许通过+-键调整音调
        if (isNoteInput) {
          if ((e.key === '+' || e.key === '=') || (e.key === '-' || e.key === '_')) {
            // 让音符输入框的keydown事件处理器处理这些键
            return;
          }
        }
        // 对于非文本输入框，允许控制全局音调
        else if (!isTextInput) {
          if (e.key === '+' || e.key === '=') {
            e.preventDefault();
            if (globalToneOffset < 2) {
              globalToneOffset++;
              updateToneDisplay();
              // 视觉反馈：触发按钮的点击效果
              increaseToneBtn.classList.add('bg-gray-200');
              setTimeout(() => increaseToneBtn.classList.remove('bg-gray-200'), 150);
            }
          } else if (e.key === '-' || e.key === '_') {
            e.preventDefault();
            if (globalToneOffset > -1) {
              globalToneOffset--;
              updateToneDisplay();
              // 视觉反馈：触发按钮的点击效果
              decreaseToneBtn.classList.add('bg-gray-200');
              setTimeout(() => decreaseToneBtn.classList.remove('bg-gray-200'), 150);
            }
          }
      };
      
      // 预览设置相关
      const fontSelect = document.getElementById('fontSelect');
      const noteColorSelect = document.getElementById('noteColorSelect');
      const noteColorPicker = document.getElementById('noteColorPicker');
      const textColorSelect = document.getElementById('textColorSelect');
      const textColorPicker = document.getElementById('textColorPicker');
      const applySettingsBtn = document.getElementById('applySettingsBtn');
      const clearBgBtn = document.getElementById('clearBgBtn');
      const bgImageUpload = document.getElementById('bgImageUpload');
      
      // 字体选择
      fontSelect.addEventListener('change', () => {
        previewSettings.font = fontSelect.value;
        // 立即更新预览，使字体更改生效
        updatePreview();
      });
      
      // 字体加粗切换
      const toggleBoldBtn = document.getElementById('toggleBoldBtn');
      
      toggleBoldBtn.addEventListener('click', () => {
        previewSettings.bold = !previewSettings.bold;
        // 更新按钮样式以反映状态
        toggleBoldBtn.classList.toggle('bg-primary/10', previewSettings.bold);
        toggleBoldBtn.classList.toggle('border-primary', previewSettings.bold);
        toggleBoldBtn.classList.toggle('text-primary', previewSettings.bold);
        toggleBoldBtn.classList.toggle('text-gray-600', !previewSettings.bold);
        // 立即更新预览，使加粗效果生效
        updatePreview();
      });
      
      // 字体大小设置
      const fontSizeSlider = document.getElementById('fontSizeSlider');
      const fontSizeDisplay = document.getElementById('fontSizeDisplay');
      
      fontSizeSlider.addEventListener('input', () => {
        const fontSize = parseInt(fontSizeSlider.value);
        previewSettings.fontSize = fontSize;
        fontSizeDisplay.textContent = fontSize;
        // 立即更新预览，使字体大小更改生效
        updatePreview();
      });
      
      // 音符颜色选择
      noteColorSelect.addEventListener('change', () => {
        previewSettings.noteColor = noteColorSelect.value;
        noteColorPicker.value = noteColorSelect.value;
        // 立即更新预览，使颜色更改生效
        updatePreview();
      });
      
      noteColorPicker.addEventListener('input', () => {
        previewSettings.noteColor = noteColorPicker.value;
        // 更新下拉框以匹配颜色选择器
        for (let i = 0; i < noteColorSelect.options.length; i++) {
          if (noteColorSelect.options[i].value === noteColorPicker.value) {
            noteColorSelect.selectedIndex = i;
            break;}
          }
          // 立即更新预览，使颜色更改生效
          updatePreview();
        });
      
      // 歌词颜色选择
      textColorSelect.addEventListener('change', () => {
        previewSettings.textColor = textColorSelect.value;
        textColorPicker.value = textColorSelect.value;
        // 立即更新预览，使颜色更改生效
        updatePreview();
      });
      
      textColorPicker.addEventListener('input', () => {
        previewSettings.textColor = textColorPicker.value;
        // 更新下拉框以匹配颜色选择器
        for (let i = 0; i < textColorSelect.options.length; i++) {
          if (textColorSelect.options[i].value === textColorPicker.value) {
            textColorSelect.selectedIndex = i;
            break;
          }
        }
        // 立即更新预览，使颜色更改生效
        updatePreview();
      });
      
      // 背景选择
      document.querySelectorAll('[data-bg]').forEach(item => {
        item.addEventListener('click', () => {
            // 移除所有选中状态
            document.querySelectorAll('[data-bg]').forEach(el => {
              el.classList.remove('border-primary');
              el.classList.add('border-gray-200');
            });
            
            // 添加选中状态
            item.classList.remove('border-gray-200');
            item.classList.add('border-primary');
            
            // 设置背景
            previewSettings.backgroundImage = item.dataset.bg;
            
            // 立即更新预览
            updatePreview();
          });
      });
      
      // 自定义背景图上传
      bgImageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            previewSettings.backgroundImage = event.target.result;
            
            // 移除所有选中状态
            document.querySelectorAll('[data-bg]').forEach(el => {
              el.classList.remove('border-primary');
              el.classList.add('border-gray-200');
            });
            
            // 立即更新预览
            updatePreview();
          };
          reader.readAsDataURL(file);
        }
      });
      
      // 清除背景
      clearBgBtn.addEventListener('click', () => {
        previewSettings.backgroundImage = 'none';
        
        // 移除所有选中状态
        document.querySelectorAll('[data-bg]').forEach(el => {
          el.classList.remove('border-primary');
          el.classList.add('border-gray-200');
        });
        
        // 选中"无背景"选项
        document.querySelector('[data-bg="none"]').classList.remove('border-gray-200');
        document.querySelector('[data-bg="none"]').classList.add('border-primary');
        
        // 更新预览
        updatePreview();
      });
      
      // 应用设置按钮
      applySettingsBtn.addEventListener('click', () => {
        updatePreview();
      });
      
      // 宽高比选择
      const aspectRatioSelect = document.getElementById('aspectRatioSelect');
      const customRatioInputs = document.getElementById('customRatioInputs');
      const widthInput = document.getElementById('widthInput');
      const heightInput = document.getElementById('heightInput');
      const applyRatioBtn = document.getElementById('applyRatioBtn');
      
      aspectRatioSelect.addEventListener('change', () => {
        if (aspectRatioSelect.value === 'custom') {
          customRatioInputs.classList.remove('hidden');
        } else {
          customRatioInputs.classList.add('hidden');
          previewSettings.aspectRatio = aspectRatioSelect.value;
          
          // 更新预览区域宽高比
          updatePreviewAreaAspectRatio();
          updatePreview();
        }
      });
      
      // 应用自定义宽高比
      applyRatioBtn.addEventListener('click', () => {
        const width = parseInt(widthInput.value);
        const height = parseInt(heightInput.value);
        
        if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
          previewSettings.width = width;
          previewSettings.height = height;
          
          // 更新预览区域宽高比
          updatePreviewAreaAspectRatio(true);
          updatePreview();
        } else {
          alert('请输入有效的宽度和高度');
        }
      });
      
      // 分页设置
      const linesPerPageInput = document.getElementById('linesPerPageInput');

      const pageInfo = document.getElementById('pageInfo');
      const currentPageDisplay = document.getElementById('currentPageDisplay');
      const totalPagesDisplay = document.getElementById('totalPagesDisplay');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const exportAllBtn = document.getElementById('exportAllBtn');
      
      // 更新分页信息
      // updatePaginationInfo函数已移至全局作用域
      
      // 每页行数输入 - 添加input和change事件监听，确保实时更新
      linesPerPageInput.addEventListener('input', handleLinesPerPageChange);
      linesPerPageInput.addEventListener('change', handleLinesPerPageChange);
      
      function handleLinesPerPageChange() {
        const linesPerPage = parseInt(linesPerPageInput.value);
        if (!isNaN(linesPerPage) && linesPerPage > 0) {
          paginationSettings.linesPerPage = linesPerPage;
          paginationSettings.currentPage = 1; // 重置到第一页
          updatePaginationInfo();
          updatePreview();
        } else if (linesPerPageInput.value !== '') {
          // 只在用户输入了无效值时才显示提示，避免空输入时的警告
          alert('请输入有效的行数');
          linesPerPageInput.value = paginationSettings.linesPerPage;
        }
      }
      

      
      // 上一页
      prevPageBtn.addEventListener('click', () => {
        if (paginationSettings.currentPage > 1) {
          paginationSettings.currentPage--;
          updatePaginationInfo();
          updatePreview();
        }
      });
      
      // 下一页
      nextPageBtn.addEventListener('click', () => {
        // 先更新总页数以确保准确性
        updatePaginationInfo();
        
        // 然后检查是否可以前进
        if (paginationSettings.currentPage < paginationSettings.totalPages) {
          paginationSettings.currentPage++;
          updatePaginationInfo();
          updatePreview();
        }
      });
      
      // 导出全部
      exportAllBtn.addEventListener('click', exportAllPages);
      
      // 文件名输入
      const fileNameInput = document.getElementById('fileNameInput');
      const exportFormatSelect = document.getElementById('exportFormatSelect');
      const exportDataBtn = document.getElementById('exportDataBtn');
      const importDataBtn = document.getElementById('importDataBtn');
      const dataFileInput = document.getElementById('dataFileInput');
      
      exportFormatSelect.addEventListener('change', () => {
        // 更新文件名后缀显示
        const extension = exportFormatSelect.value;
        const extensionDisplay = document.querySelector('.text-gray-500.self-center');
        extensionDisplay.textContent = '.' + extension;
      });

      // 导出数据为JSON文件
      exportDataBtn.addEventListener('click', () => {
        if (lyricsData.length === 0) {
          // 使用更友好的提示方式替代alert
          showNotification('没有数据可导出', 'warning');
          return;
        }
        
        // 准备导出数据
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          songTitle: document.getElementById('songTitleInput').value || '未命名歌曲',
          singer: document.getElementById('singerInput').value || '',
          lyricsData: lyricsData,
          paginationSettings: {
            linesPerPage: paginationSettings.linesPerPage
          }
        };
        
        // 创建Blob对象
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // 创建下载链接
        const a = document.createElement('a');
        a.href = url;
        const songTitle = exportData.songTitle.replace(/[^\w\u4e00-\u9fa5]/gi, '_');
        a.download = `${songTitle}_简谱数据.json`;
        
        // 为了避免事件循环问题，使用setTimeout异步执行下载
        setTimeout(() => {
          document.body.appendChild(a);
          a.click();
          
          // 清理
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // 使用更友好的提示方式替代alert
            showNotification('数据导出成功！', 'success');
          }, 100);
        }, 0);
      });
      
      // 显示通知函数
      function showNotification(message, type = 'info') {
        // 检查是否已有通知元素，有则移除
        const existingNotification = document.querySelector('.notification-toast');
        if (existingNotification) {
          existingNotification.remove();
        }
        
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `notification-toast fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ease-in-out ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' : 'bg-blue-100 text-blue-800 border border-blue-300'}`;
        notification.innerHTML = `
          <div class="flex items-center justify-between">
            <span>${message}</span>
            <button class="ml-4 text-gray-500 hover:text-gray-700">
              <i class="fa fa-times"></i>
            </button>
          </div>
        `;
        
        // 添加点击关闭事件
        notification.querySelector('button').addEventListener('click', () => {
          notification.classList.add('opacity-0', 'translate-y-2');
          setTimeout(() => {
            notification.remove();
          }, 300);
        });
        
        // 添加到文档并自动消失
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.classList.add('opacity-0', 'translate-y-2');
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }
      
      // 导入数据文件
      // 先移除可能存在的旧事件监听器
      const newDataFileInput = document.createElement('input');
      newDataFileInput.type = 'file';
      newDataFileInput.id = 'dataFileInput';
      newDataFileInput.accept = '.json';
      newDataFileInput.className = 'hidden';
      
      // 替换旧的input元素
      const oldDataFileInput = document.getElementById('dataFileInput');
      if (oldDataFileInput) {
        oldDataFileInput.parentNode.replaceChild(newDataFileInput, oldDataFileInput);
      }
      
      // 重新获取引用
      const updatedDataFileInput = document.getElementById('dataFileInput');
      
      // 绑定点击事件
      importDataBtn.addEventListener('click', () => {
        updatedDataFileInput.click();
      });
      
      // 绑定change事件
      updatedDataFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
          showNotification('请选择JSON格式的文件', 'warning');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            
            // 验证数据结构
            if (!importedData.lyricsData || !Array.isArray(importedData.lyricsData)) {
              throw new Error('无效的数据结构：缺少lyricsData数组');
            }
            
            // 确保数据格式正确，修复可能缺失的字段
            const validatedLyricsData = [];
            importedData.lyricsData.forEach((row, lineIndex) => {
              if (row && row.characters && Array.isArray(row.characters)) {
                // 确保每行数据有必要的字段
                const validatedRow = {
                  id: row.id || `row-${lineIndex}`,
                  lineNumber: row.lineNumber || lineIndex + 1,
                  characters: []
                };
                
                // 确保每个字符数据有必要的字段
                row.characters.forEach((charObj, charIndex) => {
                  validatedRow.characters.push({
                    text: charObj.text || '',
                    note: charObj.note || '',
                    octave: charObj.octave !== undefined ? charObj.octave : 0,
                    index: charObj.index !== undefined ? charObj.index : charIndex
                  });
                });
                
                validatedLyricsData.push(validatedRow);
              }
            });
            
            // 恢复数据
            lyricsData = validatedLyricsData;
            
            // 恢复歌曲信息
            if (importedData.songTitle) {
              document.getElementById('songTitleInput').value = importedData.songTitle;
            }
            if (importedData.singer) {
              document.getElementById('singerInput').value = importedData.singer;
            }
            
            // 恢复分页设置
            if (importedData.paginationSettings && importedData.paginationSettings.linesPerPage) {
              document.getElementById('linesPerPageInput').value = importedData.paginationSettings.linesPerPage;
              paginationSettings.linesPerPage = importedData.paginationSettings.linesPerPage;
            }
            
            // 重置到第一页
            paginationSettings.currentPage = 1;
            
            // 重新生成歌词文本
            let lyricsText = '';
            lyricsData.forEach(row => {
              let lineText = '';
              row.characters.forEach(char => {
                lineText += char.text;
              });
              lyricsText += lineText + '\n';
            });
            lyricsInput.value = lyricsText.trim();
            
            // 更新编辑器和预览 - 按正确顺序调用
            updatePaginationInfo(); // 先更新分页信息
            renderNotesEditor();    // 再渲染编辑器
            updatePreview();        // 最后更新预览
            
            showNotification('数据导入成功！', 'success');
          } catch (error) {
            console.error('导入错误详情:', error);
            showNotification('数据导入失败：' + error.message, 'warning');
          } finally {
            // 清空文件输入，允许重复选择同一文件
            updatedDataFileInput.value = '';
          }
        };
        
        // 添加错误处理
        reader.onerror = () => {
          showNotification('文件读取失败，请重试', 'warning');
          updatedDataFileInput.value = '';
        };
        
        reader.readAsText(file);
      });
    });
  }

  // 更新预览区域宽高比
  function updatePreviewAreaAspectRatio(custom = false) {
    if (custom) {
      // 自定义义宽高比
      const width = previewSettings.width;
      const height = previewSettings.height;
      const ratio = width / height;
      
      // 使用style属性设置宽高比
      previewArea.style.aspectRatio = ratio;
      // 同时更新CSS变量，用于后续兼容性类样式表也能访问到
      document.documentElement.style.setProperty('--preview-aspect-ratio', ratio);
    } else {
      // 预设宽高比
      const ratioParts = previewSettings.aspectRatio.split(':');
      const ratio = ratioParts[0] / ratioParts[1];
        
      // 使用style属性设置宽高比
      previewArea.style.aspectRatio = ratio;
      // 同时更新CSS变量
      document.documentElement.style.setProperty('--preview-aspect-ratio', ratio);
    }
    
    // 更新预览览
    updatePreview();
  }

  // 更新分页信息
  function updatePaginationInfo() {
    if (lyricsData.length === 0) {
      pageInfo.classList.add('hidden');
      return;
    }
    
    paginationSettings.totalPages = Math.ceil(lyricsData.length / paginationSettings.linesPerPage);
    currentPageDisplay.textContent = paginationSettings.currentPage;
    totalPagesDisplay.textContent = paginationSettings.totalPages;
    
    // 更新按钮状态
    prevPageBtn.disabled = paginationSettings.currentPage === 1;
    nextPageBtn.disabled = paginationSettings.currentPage === paginationSettings.totalPages;
    
    pageInfo.classList.remove('hidden');
  }

    // 分割歌词为单个字符，并创建对应的简谱数据结构
    function splitLyrics() {
      const lyrics = lyricsInput.value.trim();
      if (!lyrics) {
        alert('请先输入歌词');
        return;
      }
      
      // 分割前先保存当前歌词到缓存
      saveLyricsToCache();
      
      // 按行分割歌词
      const lines = lyrics.split('\n');
      lyricsData = [];
      
      // 为每行创建数据
      lines.forEach((line, lineIndex) => {
        const trimmedLine = line.trim();
        if (trimmedLine) {
          const rowData = {
            id: `row-${lineIndex}`,
            lineNumber: lineIndex + 1,
            characters: []
          };
          
          // 将每行分割为单个字符
          for (let i = 0; i < trimmedLine.length; i++) {
            const char = trimmedLine[i];
            // 跳过空字符
            if (char.trim() === '') continue;
            
            rowData.characters.push({
              text: char,
              note: '',
              octave: 0,
              index: i
            });
          }
          
          lyricsData.push(rowData);
        }
      });
      
      // 渲染简谱编辑器
      renderNotesEditor();
      
      // 更新预览
      updatePreview();
    }

    // 渲染简谱编辑器
    function renderNotesEditor() {
      if (lyricsData.length === 0) {
        notesEditor.innerHTML = `
          <div class="text-gray-500 text-center py-10 border-2 border-dashed border-gray-200 rounded-lg">
            <p>请先输入歌词并点击"分割歌词"按钮</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      // 为每行创建编辑器
      lyricsData.forEach((row, rowIndex) => {
        html += `
          <div class="note-row p-3 border border-gray-200 rounded-lg" data-row-id="${row.id}">
            <div class="flex items-center mb-2">
              <span class="bg-primary text-white text-xs px-2 py-1 rounded-md mr-2">第 ${row.lineNumber} 行</span>
              <div class="flex-1 h-px bg-gray-200"></div>
            </div>
            <div class="flex flex-wrap gap-2">
        `;
        
        // 为每个字符创建音符输入框
        row.characters.forEach((charObj, charIndex) => {
          const noteValue = charObj.note || '';
          const noteClass = noteValue ? '' : 'placeholder-gray-400';
          
          html += `
            <div class="note-item flex flex-col items-center" data-index="${charIndex}">
              <input type="text" maxlength="1" value="${noteValue}" 
                class="note-input w-8 h-8 text-center text-lg font-medium border border-gray-300 rounded-md ${noteClass} focus:outline-none focus:note-input-focus"
                data-row="${rowIndex}" data-index="${charIndex}">
              <span class="text-sm mt-1">${charObj.text}</span>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      notesEditor.innerHTML = html;
      
      // 添加事件监听
      document.querySelectorAll('.note-input').forEach(input => {
        input.addEventListener('input', handleNoteInput);
        input.addEventListener('keydown', handleNoteKeyDown);
        input.addEventListener('focus', handleNoteFocus);
      });
    }

    // 处理音符输入
    function handleNoteInput(e) {
      const input = e.target;
      const rowIndex = parseInt(input.dataset.row);
      const charIndex = parseInt(input.dataset.index);
      const value = input.value.trim();
      
      // 验证输入是否为数字1-7
      if (value && !/^[1-7]$/.test(value)) {
        input.value = '';
        return;
      }
      
      // 更新数据
      if (lyricsData[rowIndex] && lyricsData[rowIndex].characters[charIndex]) {
        lyricsData[rowIndex].characters[charIndex].note = value;
        // 只有当octave是默认值(0)时才使用全局音调偏移
        // 这样可以保留用户预先通过+-键设置的octave值
        if (lyricsData[rowIndex].characters[charIndex].octave === 0) {
          lyricsData[rowIndex].characters[charIndex].octave = globalToneOffset;
        }
        
        // 如果输入了有效音符，自动聚焦到下一个输入框
        if (value) {
          focusNextNoteInput(rowIndex, charIndex);
        }
      }
      
      // 更新预览
      updatePreview();
    }

    // 处理音符输入框的键盘事件
    function handleNoteKeyDown(e) {
      const input = e.target;
      
      // 处理+键（升调）
      if (e.key === '+' || e.key === '=') {
          e.preventDefault();
          // 增加全局音调偏移 - 限制最大值为2
          if (globalToneOffset < 2) {
            globalToneOffset++;
            console.log(`已设置全局音调偏移为: ${globalToneOffset}`);
            
            // 更新全局音调显示
            updateToneDisplay();
            
            // 临时显示当前音调值，提供即时视觉反馈
            const tempIndicator = document.createElement('div');
            tempIndicator.textContent = `+${globalToneOffset}`;
            tempIndicator.style.position = 'absolute';
            tempIndicator.style.top = '-20px';
            tempIndicator.style.left = '50%';
            tempIndicator.style.transform = 'translateX(-50%)';
            tempIndicator.style.color = '#10B981';
            tempIndicator.style.fontWeight = 'bold';
            tempIndicator.style.zIndex = '10';
            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(tempIndicator);
            
            // 移除临时指示器
            setTimeout(() => {
              if (tempIndicator.parentNode) {
                tempIndicator.parentNode.removeChild(tempIndicator);
              }
            }, 800);
            
            // 更新预览，所有使用默认octave的音符都会受到全局音调偏移的影响
            updatePreview();
          }
      }
      
      // 处理-键（降调）
      if (e.key === '-' || e.key === '_') {
          e.preventDefault();
          // 减少全局音调偏移 - 限制最小值为-1
          if (globalToneOffset > -1) {
            globalToneOffset--;
            console.log(`已设置全局音调偏移为: ${globalToneOffset}`);
            
            // 更新全局音调显示
            updateToneDisplay();
            
            // 临时显示当前音调值，提供即时视觉反馈
            const tempIndicator = document.createElement('div');
            tempIndicator.textContent = globalToneOffset;
            tempIndicator.style.position = 'absolute';
            tempIndicator.style.top = '-20px';
            tempIndicator.style.left = '50%';
            tempIndicator.style.transform = 'translateX(-50%)';
            tempIndicator.style.color = '#3B82F6';
            tempIndicator.style.fontWeight = 'bold';
            tempIndicator.style.zIndex = '10';
            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(tempIndicator);
            
            // 移除临时指示器
            setTimeout(() => {
              if (tempIndicator.parentNode) {
                tempIndicator.parentNode.removeChild(tempIndicator);
              }
            }, 800);
            
            // 更新预览，所有使用默认octave的音符都会受到全局音调偏移的影响
            updatePreview();
          }
      }
      
      // 处理Delete键
      if (e.key === 'Delete' || e.key === 'Backspace') {
        if (!input.value) {
          // 如果当前输入框为空，删除前一个音符
          focusPreviousNoteInput(rowIndex, charIndex);
          const prevInput = document.querySelector(`.note-input[data-row="${rowIndex}"][data-index="${charIndex - 1}"]`);
          if (prevInput) {
            prevInput.value = '';
            if (lyricsData[rowIndex] && lyricsData[rowIndex].characters[charIndex - 1]) {
              lyricsData[rowIndex].characters[charIndex - 1].note = '';
              lyricsData[rowIndex].characters[charIndex - 1].octave = 0;
            }
            updatePreview();
          }
        } else {
          // 清空当前音符的八度
          if (lyricsData[rowIndex] && lyricsData[rowIndex].characters[charIndex]) {
            lyricsData[rowIndex].characters[charIndex].octave = 0;
          }
        }
      }
      
      // 处理方向键
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        focusNextNoteInput(rowIndex, charIndex);
      }
      
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        focusPreviousNoteInput(rowIndex, charIndex);
      }
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        // 跳转到下一行的对应位置
        if (rowIndex < lyricsData.length - 1) {
          const nextRowIndex = rowIndex + 1;
          const nextRowChars = lyricsData[nextRowIndex].characters.length;
          const targetIndex = Math.min(charIndex, nextRowChars - 1);
          
          const nextInput = document.querySelector(`.note-input[data-row="${nextRowIndex}"][data-index="${targetIndex}"]`);
          if (nextInput) {
            nextInput.focus();
          }
        }
      }
      
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        // 跳转到上一行的对应位置
        if (rowIndex > 0) {
          const prevRowIndex = rowIndex - 1;
          const prevRowChars = lyricsData[prevRowIndex].characters.length;
          const targetIndex = Math.min(charIndex, prevRowChars - 1);
          
          const prevInput = document.querySelector(`.note-input[data-row="${prevRowIndex}"][data-index="${targetIndex}"]`);
          if (prevInput) {
            prevInput.focus();
          }
        }
      }
    }

    // 处理音符输入框获得焦点事件
    function handleNoteFocus(e) {
      const input = e.target;
      const rowIndex = parseInt(input.dataset.row);
      const charIndex = parseInt(input.dataset.index);
      
      // 更新当前聚焦位置
      currentFocusRow = rowIndex;
      currentFocusIndex = charIndex;
      
      // 选中输入框内容
      input.select();
    }

    // 聚焦到下一个音符输入框
    function focusNextNoteInput(rowIndex, charIndex) {
      const currentRow = lyricsData[rowIndex];
      
      // 如果当前行还有下一个输入框
      if (charIndex < currentRow.characters.length - 1) {
        const nextInput = document.querySelector(`.note-input[data-row="${rowIndex}"][data-index="${charIndex + 1}"]`);
        if (nextInput) {
          nextInput.focus();
          return;
        }
      }
      
      // 如果当前行是最后一行，则不做任何操作
      if (rowIndex === lyricsData.length - 1) {
        return;
      }
      
      // 否则跳转到下一行的第一个输入框
      const nextRowIndex = rowIndex + 1;
      const nextInput = document.querySelector(`.note-input[data-row="${nextRowIndex}"][data-index="0"]`);
      if (nextInput) {
        nextInput.focus();
      }
    }

    // 聚焦到上一个音符输入框
    function focusPreviousNoteInput(rowIndex, charIndex) {
      // 如果当前行还有上一个输入框
      if (charIndex > 0) {
        const prevInput = document.querySelector(`.note-input[data-row="${rowIndex}"][data-index="${charIndex - 1}"]`);
        if (prevInput) {
          prevInput.focus();
          return;
        }
      }
      
      // 如果当前行是第一行，则不做任何操作
      if (rowIndex === 0) {
        return;
      }
      
      // 否则跳转到上一行的最后一个输入框
      const prevRowIndex = rowIndex - 1;
      const prevRow = lyricsData[prevRowIndex];
      const lastIndex = prevRow.characters.length - 1;
      
      const prevInput = document.querySelector(`.note-input[data-row="${prevRowIndex}"][data-index="${lastIndex}"]`);
      if (prevInput) {
        prevInput.focus();
      }
    }

    // 更新音调显示
    function updateToneDisplay() {
      let displayText = '±0';
      
      if (globalToneOffset > 0) {
        displayText = '+' + globalToneOffset;
      } else if (globalToneOffset < 0) {
        displayText = globalToneOffset.toString();
      }
      
      globalToneDisplay.textContent = displayText;
    }

    // 清空歌词
    function clearLyrics() {
      if (confirm('确定要清除所有歌词和简谱数据吗？')) {
        lyricsInput.value = '';
        lyricsData = [];
        renderNotesEditor();
        updatePreview();
        
        // 清除缓存
        clearLyricsCache();
        console.log('歌词数据已清除，缓存也已清除');
      }
    }

    // 加载示例歌词
    function loadSampleLyrics() {
      const sampleLyrics = `一闪一闪亮晶晶
满天都是小星星
挂在天空放光明
好像许多小眼睛`;
      
      lyricsInput.value = sampleLyrics;
      splitLyrics();
    }

    // 更新预览
    function updatePreview() {
      if (lyricsData.length === 0) {
        previewArea.innerHTML = `
          <div class="text-gray-500 text-center py-10">
            <p>编辑后的简谱将在这里显示</p>
          </div>
        `;
        return;
      }
      
      // 应用预览设置
      previewArea.style.fontFamily = previewSettings.font;
      previewArea.style.fontSize = `${previewSettings.fontSize}px`;
      previewArea.style.fontWeight = previewSettings.bold ? 'bold' : 'normal';
      
      // 设置背景
      if (previewSettings.backgroundImage === 'none') {
        previewArea.style.backgroundColor = '#F3F4F6';
        previewArea.style.backgroundImage = 'none';
      } else {
        previewArea.style.backgroundColor = 'transparent';
        previewArea.style.backgroundImage = `url('${previewSettings.backgroundImage}')`;
        previewArea.style.backgroundSize = 'cover';
        previewArea.style.backgroundPosition = 'center';
      }
      
      // 更新背景预览的宽高比以匹配预览区域
      const ratio = window.getComputedStyle(previewArea).aspectRatio;
      document.querySelectorAll('[data-bg] div').forEach(div => {
        if (div.classList.contains('bg-cover') || div.parentElement.dataset.bg === 'none') {
          div.style.aspectRatio = ratio;
        }
      });
      
      // 计算当前页显示的行范围
      const startIndex = (paginationSettings.currentPage - 1) * paginationSettings.linesPerPage;
      const endIndex = Math.min(startIndex + paginationSettings.linesPerPage, lyricsData.length);
      const currentPageRows = lyricsData.slice(startIndex, endIndex);
      
      let html = '';
      
      // 添加歌曲信息标题
      const songTitle = document.getElementById('songTitleInput').value;
      const singer = document.getElementById('singerInput').value;
      
      if (songTitle) {
        html += `
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold" style="color: ${previewSettings.textColor}">${songTitle}</h2>
            ${singer ? `<p class="text-gray-600">${singer}</p>` : ''}
          </div>
        `;
      }
      
      // 为当前页的每行创建预览
      currentPageRows.forEach(row => {
        html += `
          <div class="flex flex-wrap justify-center gap-4 mb-6">
        `;
        
        // 为每个字符创建音符预览
        row.characters.forEach(charObj => {
          const note = charObj.note;
          const octave = charObj.octave;
          
          let noteHtml = '';
          
          if (note) {
            // 使用5行布局结构实现音调显示
              let dotColor = previewSettings.noteColor;
              
              // 根据octave值决定显示哪些行的圆点
              const hasPlus2Dot = octave >= 2;
              const hasPlus1Dot = octave >= 1;
              const hasMinus1Dot = octave <= -1;
              
              // 计算与字体大小相关的动态尺寸
              const dotSize = Math.round(previewSettings.fontSize * 0.6);
              const rowHeight = Math.round(previewSettings.fontSize * 0.9);
              const containerWidth = Math.round(previewSettings.fontSize * 1.5);
              const containerHeight = rowHeight * 4;
              
              noteHtml = `
                <div class="note-container" style="display: flex; flex-direction: column; align-items: center; width: ${containerWidth}px; height: ${containerHeight}px;">
                  <!-- +2音调 -->
                  <div class="tone-row" style="height: ${rowHeight}px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasPlus2Dot ? dotColor : 'transparent'}; font-size: ${dotSize}px;">●</span>
                  </div>
                  <!-- +1音调 -->
                  <div class="tone-row" style="height: ${rowHeight}px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasPlus1Dot ? dotColor : 'transparent'}; font-size: ${dotSize}px;">●</span>
                  </div>
                  <!-- 音符数字 -->
                  <div class="note-row" style="height: ${rowHeight}px; display: flex; align-items: center; justify-content: center;">
                    <span class="note-number font-medium" style="color: ${previewSettings.noteColor}; font-size: ${previewSettings.fontSize * 1.2}px;">${note}</span>
                  </div>
                  <!-- -1音调 -->
                  <div class="tone-row" style="height: ${rowHeight}px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasMinus1Dot ? dotColor : 'transparent'}; font-size: ${dotSize}px;">●</span>
                  </div>
                </div>
              `;
          } else {
            // 如果没有音符，显示一个占位符
            noteHtml = `<div class="w-8 h-8"></div>`;
          }
          
          html += `
            <div class="flex flex-col items-center">
              ${noteHtml}
              <span style="color: ${previewSettings.textColor}; font-size: ${previewSettings.fontSize}px; margin-top: 8px;">${charObj.text}</span>
            </div>
          `;
        });
        
        html += `
          </div>
        `;
      });
      
      previewArea.innerHTML = html;
    }

    // 导出为图片
    function exportAsImage(pageNumber = paginationSettings.currentPage, exportAll = false) {
      if (lyricsData.length === 0) {
        alert('请先输入歌词并添加简谱');
        return;
      }
      
      // 导出前先从输入框读取最新的每页行数设置
      const linesPerPageInput = document.getElementById('linesPerPageInput');
      const linesPerPage = parseInt(linesPerPageInput.value);
      if (!isNaN(linesPerPage) && linesPerPage > 0) {
        paginationSettings.linesPerPage = linesPerPage;
      }
      
      // 获取导出格式和分辨率
      const format = document.getElementById('exportFormatSelect').value;
      const resolution = parseInt(document.getElementById('resolutionSelect').value);
      
      // 获取歌曲信息
      const songTitle = document.getElementById('songTitleInput').value || '简谱';
      const singer = document.getElementById('singerInput').value;
      
      // 计算当前页显示的行范围
      const startIndex = (pageNumber - 1) * paginationSettings.linesPerPage;
      const endIndex = Math.min(startIndex + paginationSettings.linesPerPage, lyricsData.length);
      const currentPageRows = lyricsData.slice(startIndex, endIndex);
      
      // 创建文件名
      let fileName = songTitle;
      if (paginationSettings.totalPages > 1) {
        fileName += `_第${pageNumber}页`;
      }
      if (singer) {
        fileName += `_${singer}`;
      }
      
      // 创建一个临时容器用于导出
      const tempContainer = document.createElement('div');
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.top = '-9999px';
      tempContainer.style.width = `${previewSettings.width}px`;
      // 移除固定高度，让容器自适应内容
      // tempContainer.style.height = `${previewSettings.height}px`;
      tempContainer.style.padding = '20px';
      tempContainer.style.boxSizing = 'content-box'; // 确保padding不影响内容大小
      tempContainer.style.overflow = 'visible'; // 确保内容完全显示
      
      // 应用预览设置
      tempContainer.style.fontFamily = previewSettings.font;
      
      // 设置背景
      if (previewSettings.backgroundImage === 'none') {
        tempContainer.style.backgroundColor = '#F3F4F6';
      } else {
        tempContainer.style.backgroundColor = 'transparent';
        tempContainer.style.backgroundImage = `url('${previewSettings.backgroundImage}')`;
        tempContainer.style.backgroundSize = 'cover';
        tempContainer.style.backgroundPosition = 'center';
      }
      
      // 构建导出内容
      let exportHtml = '';
      
      // 添加歌曲信息标题
      if (songTitle) {
        exportHtml += `
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold" style="color: ${previewSettings.textColor}">${songTitle}</h2>
            ${singer ? `<p class="text-gray-600">${singer}</p>` : ''}
          </div>
        `;
      }
      
      // 为当前页的每行创建预览
      currentPageRows.forEach(row => {
        exportHtml += `
          <div class="flex flex-wrap justify-center gap-4 mb-6">
        `;
        
        // 为每个字符创建音符预览
        row.characters.forEach(charObj => {
          const note = charObj.note;
          const octave = charObj.octave;
          
          let noteHtml = '';
          
          if (note) {
            // 使用5行布局结构实现音调显示 - 与预览部分保持一致
            let dotColor = previewSettings.noteColor;
            
            // 根据octave值决定显示哪些行的圆点
            const hasPlus2Dot = octave >= 2;
            const hasPlus1Dot = octave >= 1;
            const hasMinus1Dot = octave <= -1;
            
            noteHtml = `
                <div class="note-container" style="display: flex; flex-direction: column; align-items: center; width: 20px; height: 45px;">
                  <!-- +2音调 -->
                  <div class="tone-row" style="height: 14px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasPlus2Dot ? dotColor : 'transparent'}; font-size: 10px;">●</span>
                  </div>
                  <!-- +1音调 -->
                  <div class="tone-row" style="height: 14px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasPlus1Dot ? dotColor : 'transparent'}; font-size: 10px;">●</span>
                  </div>
                  <!-- 音符数字 -->
                  <div class="note-row" style="height: 14px; display: flex; align-items: center; justify-content: center;">
                    <span class="note-number text-xl font-medium" style="color: ${previewSettings.noteColor};">${note}</span>
                  </div>
                  <!-- -1音调 -->
                  <div class="tone-row" style="height: 14px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: ${hasMinus1Dot ? dotColor : 'transparent'}; font-size: 10px;">●</span>
                  </div>
                </div>
              `;
          } else {
            // 如果没有音符，显示一个占位符
            noteHtml = `<div class="w-8 h-8"></div>`;
          }
          
          exportHtml += `
            <div class="flex flex-col items-center">
              ${noteHtml}
              <span class="text-base mt-2" style="color: ${previewSettings.textColor}">${charObj.text}</span>
            </div>
          `;
        });
        
        exportHtml += `
          </div>
        `;
      });
      
      // 如果有多页，添加页码信息
      if (paginationSettings.totalPages > 1) {
        exportHtml += `
          <div class="text-center text-gray-500 text-sm mt-6">
            第 ${pageNumber} 页 / 共 ${paginationSettings.totalPages} 页
          </div>
        `;
      }
      
      tempContainer.innerHTML = exportHtml;
      document.body.appendChild(tempContainer);
      
      // 使用html2canvas将临时容器转换为图片，配置为捕获完整内容
      return html2canvas(tempContainer, {
        scale: resolution,
        useCORS: true,
        logging: false,
        allowTaint: true,
        scrollY: 0,
        scrollX: 0,
        windowWidth: tempContainer.scrollWidth,
        windowHeight: tempContainer.scrollHeight,
        height: tempContainer.scrollHeight,
        width: tempContainer.scrollWidth
      }).then(canvas => {
        // 移除临时容器
        document.body.removeChild(tempContainer);
        
        // 创建下载链接
        const link = document.createElement('a');
        
        if (format === 'pdf') {
          // PDF导出（Beta版）
          alert('PDF导出功能正在开发中，敬请期待！');
          return Promise.resolve(false);
        } else if (format === 'jpg') {
          // JPG格式
          link.href = canvas.toDataURL('image/jpeg', 0.95);
          link.download = `${fileName}.jpg`;
        } else {
          // 默认PNG格式
          link.href = canvas.toDataURL('image/png');
          link.download = `${fileName}.png`;
        }
        
        // 触发下载
        link.click();
        
        return Promise.resolve(true);
      }).catch(error => {
        console.error('导出图片失败:', error);
        
        // 移除临时容器
        document.body.removeChild(tempContainer);
        
        return Promise.resolve(false);
      });
    }
    
    // 导出所有页
    async function exportAllPages() {
      if (lyricsData.length === 0) {
        alert('请先输入歌词并添加简谱');
        return;
      }
      
      // 导出前先从输入框读取最新的每页行数设置
      const linesPerPageInput = document.getElementById('linesPerPageInput');
      const linesPerPage = parseInt(linesPerPageInput.value);
      if (!isNaN(linesPerPage) && linesPerPage > 0) {
        paginationSettings.linesPerPage = linesPerPage;
      }
      
      // 更新总页数
      paginationSettings.totalPages = Math.ceil(lyricsData.length / paginationSettings.linesPerPage);
      
      if (paginationSettings.totalPages === 1) {
        // 只有一页，直接导出
        exportAsImage(1, true);
        return;
      }
      
      // 显示确认对话框
      const confirmExport = confirm(`确定要导出全部 ${paginationSettings.totalPages} 页吗？`);
      if (!confirmExport) {
        return;
      }
      
      // 保存当前页码
      const originalPage = paginationSettings.currentPage;
      
      // 导出计数器
      let exportedCount = 0;
      
      try {
        // 逐页导出
        for (let i = 1; i <= paginationSettings.totalPages; i++) {
          // 更新当前页码
          paginationSettings.currentPage = i;
          updatePaginationInfo();
          
          // 导出当前页
          const success = await exportAsImage(i, true);
          if (success) {
            exportedCount++;
          }
          
          // 短暂延迟，避免浏览器阻止多次下载
          if (i < paginationSettings.totalPages) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }
        
        // 恢复原始页码
        paginationSettings.currentPage = originalPage;
        updatePaginationInfo();
        updatePreview();
        
        // 显示导出成功提示
        const exportedCountElement = document.getElementById('exportedCount');
        exportedCountElement.textContent = exportedCount;
        exportStatus.classList.remove('hidden');
        
        setTimeout(() => {
          exportStatus.classList.add('hidden');
        }, 5000);
      } catch (error) {
        console.error('批量导出失败:', error);
        alert('批量导出失败，请重试！');
        
        // 恢复原始页码
        paginationSettings.currentPage = originalPage;
        updatePaginationInfo();
        updatePreview();
      }
    }

    // 从localStorage加载歌词缓存
    function loadLyricsFromCache() {
      try {
        const cachedLyrics = localStorage.getItem('lyricLine_cache');
        if (cachedLyrics) {
          const cache = JSON.parse(cachedLyrics);
          
          // 恢复歌词输入框内容
          if (cache.lyrics) {
            lyricsInput.value = cache.lyrics;
          }
          
          // 恢复歌曲信息
          if (cache.songTitle) {
            document.getElementById('songTitleInput').value = cache.songTitle;
          }
          if (cache.singer) {
            document.getElementById('singerInput').value = cache.singer;
          }
          
          // 恢复每页行数设置
          if (cache.linesPerPage) {
            document.getElementById('linesPerPageInput').value = cache.linesPerPage;
            paginationSettings.linesPerPage = cache.linesPerPage;
          }
          
          // 恢复预览设置
          if (cache.previewSettings) {
            Object.assign(previewSettings, cache.previewSettings);

          }
          
          // 如果有歌词，自动分割以恢复数据结构
          if (cache.lyrics) {
            splitLyrics();
          }
          
          // 确保设置应用到预览区域
          setTimeout(() => {
            updatePreview();
          }, 100);
          
          console.log('已从缓存恢复歌词数据和预览设置');
        }
      } catch (error) {
        console.error('读取歌词缓存失败:', error);
      }
    }
    
    // 将歌词数据保存到localStorage
    function saveLyricsToCache() {
      try {
        const cache = {
          lyrics: lyricsInput.value,
          songTitle: document.getElementById('songTitleInput').value,
          singer: document.getElementById('singerInput').value,
          linesPerPage: paginationSettings.linesPerPage,
          previewSettings: {...previewSettings},  // 保存预览设置
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('lyricLine_cache', JSON.stringify(cache));
        console.log('歌词数据已保存到缓存');
      } catch (error) {
        console.error('保存歌词缓存失败:', error);
      }
    }
    
    // 清除歌词缓存
    function clearLyricsCache() {
      try {
        localStorage.removeItem('lyricLine_cache');
        console.log('歌词缓存已清除');
      } catch (error) {
        console.error('清除歌词缓存失败:', error);
      }
    }
    
    // 初始化
    function init() {
      initEventListeners();
      updateToneDisplay();
      
      // 初始化预览览区域宽高比
      updatePreviewAreaAspectRatio();
      
      // 默认选中"无背景"选项
      document.querySelector('[data-bg="none"]').classList.remove('border-gray-200');
      document.querySelector('[data-bg="none"]').classList.add('border-primary');
      
      // 尝试从缓存加载歌词数据
      loadLyricsFromCache();
      
      // 添加清除缓存按钮
      const clearCacheBtn = document.createElement('button');
      clearCacheBtn.id = 'clearCacheBtn';
      clearCacheBtn.textContent = '清除缓存';
      clearCacheBtn.className = 'ml-2 bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-md text-sm btn-hover';
      clearCacheBtn.onclick = function() {
        if (confirm('确定要清除歌词缓存吗？')) {
          clearLyricsCache();
          alert('缓存已清除');
        }
      };
      
      // 将清除缓存按钮添加到合适的位置（歌词输入区下方）
      const lyricsInputContainer = lyricsInput.parentElement;
      if (lyricsInputContainer) {
        lyricsInputContainer.appendChild(clearCacheBtn);
      }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
